<!DOCTYPE html>
<html>
<head>
    <title>Pi Platform Interface</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=700">
    <style>
        body { text-align: center; font-family: sans-serif; background: #f5f5f5; }
        button { font-size: 24px; padding: 10px 20px; margin: 5px; }
        #logConsole { 
            white-space: pre-wrap; 
            background: #000; 
            color: #0f0; 
            padding: 10px; 
            height: 300px; 
            overflow-y: scroll; 
            text-align: left; 
            margin: 10px; 
            font-size: 16px; 
            border-radius: 5px; 
        }
        .slider-container {
            margin: 20px;
        }
        .slider-label {
            font-size: 18px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div>
        <div id="cameraFeed">
            <h1>Camera Feed</h1>
            <img id="cameraImage" src="" alt="Camera Feed" style="width: 640px; height: 480px;"><br/>
        </div>
        <div id="botControls">
            <h1>Teleop Controls</h1>
            <button onclick="sendCommand('forward')">↑</button><br/>
            <button onclick="sendCommand('left')">←</button>
            <button onclick="sendCommand('stop')">⏹</button>
            <button onclick="sendCommand('right')">→</button><br/>
            <button onclick="sendCommand('backward')">↓</button><br/>
        </div>
        <div id="velocityControl" class="slider-container">
            <h1>Velocity Control</h1>
            <label for="velocitySlider" class="slider-label">Max Velocity: <span id="velocityValue">1.0</span></label>
            <input type="range" id="velocitySlider" min="0.1" max="2.0" step="0.1" value="1.0" oninput="updateVelocity(this.value)">
        </div>
        <div id="software">
            <h1>Software Versioning</h1>
            <button onclick="sendUpdateCommand()">Update</button><br/>
            <button onclick="sendBuildCommand()">Build</button><br/>
        </div>
        <div id="gitInfo">
            <h1>Git Information</h1>
            <p>Current Git Hash: <span id="gitHash">unknown</span></p>
        </div>
        <div id="loggerLevel">
        </div>
        <div id="logs">
            <h1>System Logs</h1>
            Logger level
            <select id="loggerLevelDropdown" onchange="updateLoggerLevel()">
                <option value="DEBUG">DEBUG</option>
                <option value="INFO" selected>INFO</option>
                <option value="WARNING">WARNING</option>
                <option value="ERROR">ERROR</option>
                <option value="CRITICAL">CRITICAL</option>
            </select>
            <div id="logConsole">
            </div>
        </div>
    </div>
    <script>
        let maxVelocity = 1.0;

        function sendCommand(cmd) {
            let left = 0.0, right = 0.0;
            if (cmd === "forward") { left = maxVelocity; right = maxVelocity; }
            else if (cmd === "backward") { left = -maxVelocity; right = -maxVelocity; }
            else if (cmd === "left") { left = -maxVelocity; right = maxVelocity; }
            else if (cmd === "right") { left = maxVelocity; right = -maxVelocity; }
            else if (cmd === "stop") { left = 0.0; right = 0.0; }
            fetch('/cmd', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({left: left, right: right})
            });
        }

        function updateVelocity(value) {
            maxVelocity = parseFloat(value);
            document.getElementById('velocityValue').innerText = value;
        }

        function fetchCameraSnapshot() {
            const element = document.getElementById('cameraImage');
            element.hidden = false;
            fetch('/camera')
                .then(response => response.blob())
                .then(blob => {
                    if (blob.size > 0) {
                        element.src = URL.createObjectURL(blob);
                    }
                });
        }

        function fetchGitHash() {
            fetch('/git-hash')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('gitHash').innerText = data.git_hash;
                });
        }

        function sendUpdateCommand() {
            fetch('/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert('Update successful! Don\'t forget to reboot!');
                      document.getElementById('gitHash').innerText = data.git_hash;
                  } else {
                      alert('Update failed!');
                  }
              });
        }

        function sendBuildCommand() {
            fetch('/build', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
            }).then(response => {
                if (response.ok) {
                    alert('Build successful!');
                } else {
                    alert('Build failed!');
                }
            });
        }

        function fetchLogs() {
            fetch('/logs')
                .then(response => response.json())
                .then(data => {
                    const logElement = document.getElementById('logConsole');
                    if (data.success) {
                        logElement.innerText = data.logs;
                    } else {
                        logElement.innerText = `Error fetching logs: ${data.error}`;
                    }
                });
        }

        function updateLoggerLevel() {
            const level = document.getElementById('loggerLevelDropdown').value;
            fetch('/logger-level', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({level: level})
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert(data.message);
                  } else {
                      alert(`Failed to update logger level: ${data.error}`);
                  }
              });
        }

        setInterval(fetchCameraSnapshot, 1000);
        setInterval(fetchLogs, 500);
        fetchGitHash();
    </script>
</body>
</html>